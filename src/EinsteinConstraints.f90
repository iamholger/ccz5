SUBROUTINE EnforceCCZ4Constraints(luh)
    IMPLICIT NONE
    ! Argument list
    REAL, INTENT(INOUT)  :: luh(59)              ! numerical solution  
    ! Local variables
    INTEGER :: i,j,k,l,iVar,iDim, iter
    REAL    :: Q(59) 
    REAL    :: g_cov(3,3), det, g_contr(3,3), Aex(3,3), traceA, phi  
    REAL    :: DD(3,3,3), traceDk 
#if defined(CCZ4EINSTEIN) || defined(CCZ4GRMHD) || defined(CCZ4GRHD) || defined(CCZ4GRGPR) 
    !
            Q = luh(:) 
            ! 
            g_cov(1,1) = Q(1)
            g_cov(1,2) = Q(2)
            g_cov(1,3) = Q(3)
            g_cov(2,1) = Q(2)
            g_cov(2,2) = Q(4)
            g_cov(2,3) = Q(5)
            g_cov(3,1) = Q(3)
            g_cov(3,2) = Q(5)
            g_cov(3,3) = Q(6)
            ! This determinant should be close to unity, since we use the conformal decomposition 
            det = (Q(1)*Q(4)*Q(6)-Q(1)*Q(5)**2-Q(2)**2*Q(6)+2*Q(2)*Q(3)*Q(5)-Q(3)**2*Q(4)) 
            g_contr(1,1) = (Q(4)*Q(6)-Q(5)**2)   / det 
            g_contr(1,2) = -(Q(2)*Q(6)-Q(3)*Q(5))/ det 
            g_contr(1,3) = (Q(2)*Q(5)-Q(3)*Q(4)) / det 
            g_contr(2,1) = -(Q(2)*Q(6)-Q(3)*Q(5))/ det 
            g_contr(2,2) = (Q(1)*Q(6)-Q(3)**2)   / det 
            g_contr(2,3) = -(Q(1)*Q(5)-Q(2)*Q(3))/ det 
            g_contr(3,1) = (Q(2)*Q(5)-Q(3)*Q(4)) / det 
            g_contr(3,2) = -(Q(1)*Q(5)-Q(2)*Q(3))/ det 
            g_contr(3,3) = (Q(1)*Q(4)-Q(2)**2)   / det 
            !
            phi = det**(-1./6.) 
            g_cov = phi**2*g_cov
            det = (g_cov(1,1)*g_cov(2,2)*g_cov(3,3)-g_cov(1,1)*g_cov(2,3)*g_cov(3,2)-g_cov(2,1)*g_cov(1,2)*g_cov(3,3)+g_cov(2,1)*g_cov(1,3)*g_cov(3,2)+g_cov(3,1)*g_cov(1,2)*g_cov(2,3)-g_cov(3,1)*g_cov(1,3)*g_cov(2,2)) 
            g_contr(1,1) =  (g_cov(2,2)*g_cov(3,3)-g_cov(2,3)*g_cov(3,2)) / det 
            g_contr(1,2) = -(g_cov(1,2)*g_cov(3,3)-g_cov(1,3)*g_cov(3,2)) / det
            g_contr(1,3) = -(-g_cov(1,2)*g_cov(2,3)+g_cov(1,3)*g_cov(2,2))/ det 
            g_contr(2,1) = -(g_cov(2,1)*g_cov(3,3)-g_cov(2,3)*g_cov(3,1)) / det 
            g_contr(2,2) = (g_cov(1,1)*g_cov(3,3)-g_cov(1,3)*g_cov(3,1))  / det 
            g_contr(2,3) = -(g_cov(1,1)*g_cov(2,3)-g_cov(1,3)*g_cov(2,1)) / det 
            g_contr(3,1) = -(-g_cov(2,1)*g_cov(3,2)+g_cov(2,2)*g_cov(3,1))/ det 
            g_contr(3,2) = -(g_cov(1,1)*g_cov(3,2)-g_cov(1,2)*g_cov(3,1)) / det 
            g_contr(3,3) = (g_cov(1,1)*g_cov(2,2)-g_cov(1,2)*g_cov(2,1))  / det 
            !
            Aex(1,1) = Q(7) 
            Aex(1,2) = Q(8) 
            Aex(1,3) = Q(9) 
            Aex(2,1) = Q(8) 
            Aex(2,2) = Q(10) 
            Aex(2,3) = Q(11) 
            Aex(3,1) = Q(9) 
            Aex(3,2) = Q(11) 
            Aex(3,3) = Q(12)             
            !
            traceA = SUM(g_contr*Aex) 
            !
            Aex = Aex - 1./3.*g_cov*traceA 
            !
            luh( 1) = g_cov(1,1) 
            luh( 2) = g_cov(1,2) 
            luh( 3) = g_cov(1,3) 
            luh( 4) = g_cov(2,2) 
            luh( 5) = g_cov(2,3) 
            luh( 6) = g_cov(3,3) 
            !
            luh( 7) = Aex(1,1) 
            luh( 8) = Aex(1,2) 
            luh( 9) = Aex(1,3) 
            luh(10) = Aex(2,2) 
            luh(11) = Aex(2,3) 
            luh(12) = Aex(3,3)             
            !
            ! As suggested by our PRD referee, we also enforce the algebraic constraint that results from the first spatial derivative of the constraint
            ! det \tilde{\gamma}_ij = 0, which leads to
            !
            ! \tilde{\gamma}^{ij} D_kij = 0
            !
            ! and is thus a condition of trace-freeness on all submatrices D_kij for k=1,2,3.
            !
            DD(1,1,1)=Q(36)
            DD(1,1,2)=Q(37)
            DD(1,1,3)=Q(38)
            DD(1,2,1)=Q(37)
            DD(1,2,2)=Q(39)
            DD(1,2,3)=Q(40)
            DD(1,3,1)=Q(38)
            DD(1,3,2)=Q(40)
            DD(1,3,3)=Q(41)
            !
            DD(2,1,1)=Q(42)
            DD(2,1,2)=Q(43)
            DD(2,1,3)=Q(44)
            DD(2,2,1)=Q(43)
            DD(2,2,2)=Q(45)
            DD(2,2,3)=Q(46)
            DD(2,3,1)=Q(44)
            DD(2,3,2)=Q(46)
            DD(2,3,3)=Q(47)
            !
            DD(3,1,1)=Q(48)
            DD(3,1,2)=Q(49)
            DD(3,1,3)=Q(50)
            DD(3,2,1)=Q(49)
            DD(3,2,2)=Q(51)
            DD(3,2,3)=Q(52)
            DD(3,3,1)=Q(50)
            DD(3,3,2)=Q(52)
            DD(3,3,3)=Q(53)
            !!
            DO l = 1, 3
                traceDk = SUM(g_contr*DD(l,:,:))
                DD(l,:,:) = DD(l,:,:) - 1./3.*g_cov*traceDk
            ENDDO
            !
            luh(36) = DD(1,1,1)
            luh(37) = DD(1,1,2)
            luh(38) = DD(1,1,3)
            luh(39) = DD(1,2,2)
            luh(40) = DD(1,2,3)
            luh(41) = DD(1,3,3)
            !
            luh(42) = DD(2,1,1)
            luh(43) = DD(2,1,2)
            luh(44) = DD(2,1,3)
            luh(45) = DD(2,2,2)
            luh(46) = DD(2,2,3)
            luh(47) = DD(2,3,3)
            !
            luh(48) = DD(3,1,1)
            luh(49) = DD(3,1,2)
            luh(50) = DD(3,1,3)
            luh(51) = DD(3,2,2)
            luh(52) = DD(3,2,3)
            luh(53) = DD(3,3,3)            
            !
#ifdef CCZ4GRHD 
            !IF( Q(60) < 1e-6) THEN
            !    luh(61:63,i,j,k) = 0.0                  ! in the atmosphere, there is no velocity 
            !ENDIF            
#endif 
            !

#endif 
END SUBROUTINE EnforceCCZ4Constraints 
                
program main
  implicit none
  REAL ::  Qwork(59), Qtest(59)
  integer::i,j, seed_size
  integer,allocatable :: seed(:)
  call random_seed() ! initialize with system generated seed
  call random_seed(size=seed_size) ! find out size of seed
  allocate(seed(seed_size))
  call random_seed(get=seed) ! get system generated seed
  seed=314159261
  call random_seed(put=seed) ! set current seed
  call random_seed(get=seed) ! get current seed
  deallocate(seed)           ! safe



  Qwork = (/2.03876392436862219348e+00,1.13327632951146378931e-17,1.13328125850752231240e-17,9.81163922513405450943e-01,7.28991960382758263436e-20,9.81163922513405450943e-01,1.60702820377219834924e-01,-2.51854521837995827255e-14,-2.51859943549822510890e-14,-7.58958825491163335819e-02,-1.66695209611466999131e-16,-7.58958825491163335819e-02,5.73443499779581738335e-04,3.01713236980058585601e-01,-5.73062863551328161271e-12,-5.73061639353499262517e-12,2.85203957292370774423e-02,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,2.33452764998758000026e-01,-4.17807322717328905611e-12,-4.17806121758503744557e-12,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,1.66029261165760388952e-01,3.52110122269561003271e-16,3.52110623323521089469e-16,-7.84114259822868420180e-02,-1.00892874234056400197e-18,-7.84114259822868420180e-02,-2.87874071850877923045e-12,-3.11299149429065573305e-16,4.67768108082361629111e-18,1.35940313205684060638e-12,-2.07569443609550208564e-18,1.35970991086859628736e-12,-2.87874063909529684826e-12,1.43318865709343599115e-18,-3.14548568405474184678e-16,1.35970993559255365097e-12,-2.04322863271445272127e-18,1.35940303232291987362e-12,2.34302828568053289615e-01,-9.50679857641236088217e-03,-7.99171325660463643947e-02,1.44427998332769005893e-12,1.44427998345849223420e-12,0.00000000000000000000e+00/)
  Qtest = (/2.03876392436862219348e+00,1.13327632951146378931e-17,1.13328125850752231240e-17,9.81163922513405450943e-01,7.28991960382758263436e-20,9.81163922513405450943e-01,1.60702820377219834924e-01,-2.51854521837995827255e-14,-2.51859943549822510890e-14,-7.58958825491163335819e-02,-1.66695209611466999131e-16,-7.58958825491163335819e-02,5.73443499779581738335e-04,3.01713236980058585601e-01,-5.73062863551328161271e-12,-5.73061639353499262517e-12,2.85203957292370774423e-02,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,2.33452764998758000026e-01,-4.17807322717328905611e-12,-4.17806121758503744557e-12,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,1.66029261165760388952e-01,3.52110122269561003271e-16,3.52110623323521089469e-16,-7.84114259822868420180e-02,-1.00892874234056400197e-18,-7.84114259822868420180e-02,-2.87874071850877923045e-12,-3.11299149429065573305e-16,4.67768108082361629111e-18,1.35940313205684060638e-12,-2.07569443609550208564e-18,1.35970991086859628736e-12,-2.87874063909529684826e-12,1.43318865709343599115e-18,-3.14548568405474184678e-16,1.35970993559255365097e-12,-2.04322863271445272127e-18,1.35940303232291987362e-12,2.34302828568053289615e-01,-9.50679857641236088217e-03,-7.99171325660463643947e-02,1.44427998332769005893e-12,1.44427998345849223420e-12,0.00000000000000000000e+00/)



  !do i=1,100
      !call random_number(Qwork)
      !!do j=1,59 
      !!Qtest(j) = Qwork(j)
      !!enddo
      !Qtest=Qwork

      CALL EnforceCCZ4Constraints(Qwork)
      do i = 1,59
      print*,i,Qwork(i)-Qtest(i)
      enddo
      print*,sum(Qwork-Qtest)
  !enddo
end program main
